(()=>{"use strict";class e{static get CANVAS_HEIGHT(){return e.TILE_SIZE*e.CANVAS_TILE_HEIGHT}static get CANVAS_WIDTH(){return e.TILE_SIZE*e.CANVAS_TILE_WIDTH}static get ASPECT_RATIO(){return e.CANVAS_TILE_HEIGHT/e.CANVAS_TILE_WIDTH}static get UI_RENDER_LAYER(){return e.OBJECT_RENDERING_LAYERS-1}static get UI_COLLISION_LAYER(){return e.OBJECT_COLLISION_LAYERS-1}static get CANVAS_CENTER_TILE_Y(){return this.CANVAS_TILE_HEIGHT/2}static get CANVAS_CENTER_TILE_X(){return this.CANVAS_TILE_WIDTH/2}static get CANVAS_CENTER_PIXEL_X(){return e.CANVAS_WIDTH/2}static get CANVAS_CENTER_PIXEL_Y(){return e.CANVAS_HEIGHT/2}}e.CANVAS_TILE_HEIGHT=18,e.CANVAS_TILE_WIDTH=30,e.TILE_SIZE=16,e.OBJECT_RENDERING_LAYERS=16,e.OBJECT_COLLISION_LAYERS=16,e.CONTEXT_IMAGE_SMOOTHING_ENABLED=!1;class t{static renderSprite(t,i,s,n,r,o,a,h,d={}){var c,l;let g=a?a*e.TILE_SIZE:e.TILE_SIZE,u=h?h*e.TILE_SIZE:e.TILE_SIZE,m=null!==(c=d.scale)&&void 0!==c?c:1,p=null!==(l=d.rotation)&&void 0!==l?l:0,b=d.opacity&&d.opacity<1,E=0!==p,I=b||E;if(I&&(t.save(),b&&(t.globalAlpha=Math.max(0,d.opacity)),E)){let i=Math.floor((r+a/2)*e.TILE_SIZE)+.5,s=Math.floor((o+h/2)*e.TILE_SIZE)+.5;t.translate(i,s),t.rotate(p*Math.PI/180),t.translate(-i,-s)}let L=Math.floor(g/2),f=Math.floor(u/2);d.centered&&t.translate(-L,-f),t.drawImage(i,s*e.TILE_SIZE,n*e.TILE_SIZE,g,u,Math.floor(r*e.TILE_SIZE),Math.floor(o*e.TILE_SIZE),g*m,u*m),d.centered&&t.translate(L,f),I&&t.restore()}static renderSubsection(t,i,s,n,r,o){let a=Math.floor(s*e.TILE_SIZE),h=Math.floor(n*e.TILE_SIZE),d=Math.floor(r*e.TILE_SIZE),c=Math.floor(o*e.TILE_SIZE);i.drawImage(t.canvas,a,h,d-a,c-h,0,0,i.canvas.width,i.canvas.height)}static renderCircle(t,i,s,n={}){t.beginPath(),t.arc(i*e.TILE_SIZE+e.TILE_SIZE/2,s*e.TILE_SIZE+e.TILE_SIZE/2,e.TILE_SIZE/2,0,2*Math.PI),t.stroke(),t.fillStyle=n.colour||"saddlebrown",t.fill()}static fillRectangle(t,i,s,n,r,o={}){t.strokeStyle=o.colour?o.colour:"black",t.fillStyle=o.colour?o.colour:"black",t.beginPath(),t.rect(Math.floor(i*e.TILE_SIZE),Math.floor(s*e.TILE_SIZE),n,r),t.stroke(),t.fill()}static strokeRectangle(e,t,i,s,n,r){e.strokeStyle=r||"black",e.lineWidth=1,e.strokeRect(t+.5,i+.5,s-1,n-1)}static clearCanvas(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)}static createCanvas(t,i){const s=document.createElement("canvas");return s.width=t?t*e.TILE_SIZE:e.CANVAS_WIDTH,s.height=i?i*e.TILE_SIZE:e.CANVAS_HEIGHT,s}static getContext(t){let i=t.getContext("2d");return i.imageSmoothingEnabled=e.CONTEXT_IMAGE_SMOOTHING_ENABLED,i}static positionToPixelPosition(t){return t*e.TILE_SIZE}static renderText(t,i,s,n,r={}){let o=r.size?r.size:16,a=r.colour?r.colour:"black";t.font=`${o}px Helvetica`,t.fillStyle=`${a}`,t.fillText(i,s*e.TILE_SIZE,n*e.TILE_SIZE)}static textToArray(e,t,i={}){var s,n;let r=null!==(s=i.size)&&void 0!==s?s:16,o=null!==(n=i.colour)&&void 0!==n?n:"black",a=document.createElement("canvas").getContext("2d");a.font=`${r}px Helvetica`,a.fillStyle=`${o}`;let h=e.split(" "),d="",c=[];for(let e=0;e<h.length;e++){let i=`${d} ${h[e]}`;a.measureText(i).width>=t?(c.push(i),d=""):h.length-1!==e?d=i.trim():c.push(i)}return c}}class i{constructor(i,s,n,r,o,a){this.container=i,this.engineObjectList=r,this.engineObjectDetails=o,this.engineControls=a,this.CANVAS_HEIGHT=e.CANVAS_HEIGHT,this.CANVAS_WIDTH=e.CANVAS_WIDTH,this.delta=0,this.lastRenderTimestamp=0,this.assets={images:{},audio:{}},this.debug={enabled:!0,stats:{fps:!1,fpsCounter:0,objectCount:!1},breakpoint:{frame:!1},timing:{frame:!1,frameBackground:!1,frameUpdate:!1,frameRender:!1,frameDestroy:!1},ui:{grid:{lines:!1,numbers:!1},canvasLayers:!1},object:{renderBoundary:!1,renderBackground:!1}},this.gamepad=void 0,this.engineTimer=0,this.scenes=[...s],Object.keys(n.images).forEach((e=>{this.assets.images[e]=new Image,this.assets.images[e].src=n.images[e]})),Object.keys(n.audio).forEach((e=>{this.assets.audio[e]=new Audio(n.audio[e])})),this.debug.enabled&&this.initialiseDebuggerListeners(),this.canvas=this.createCanvas(),this.context=t.getContext(this.canvas),i.append(this.canvas),document.addEventListener("visibilitychange",(e=>{"visible"===document.visibilityState?console.log("tab is active"):console.log("tab is inactive")})),this.intialiseGamepadListeners(),this.changeScene(this.scenes[0]),this.frame(0)}createCanvas(){const e=t.createCanvas();return e.addEventListener("contextmenu",(e=>{e.preventDefault()})),e}changeScene(e){this.currentScene=Reflect.construct(e,[this])}frame(e){this.debug.breakpoint.frame,this.debug.timing.frame&&console.log(`[frame] ${this.delta}`),this.setDelta(e),t.clearCanvas(this.context),this.currentScene.frame(this.delta),this.debug.stats.fps&&(this.debug.stats.fpsCounter&&this.renderStats(0,"FPS",`${Math.round(1e3/(performance.now()-this.debug.stats.fpsCounter))} FPS`),this.debug.stats.fpsCounter=e),this.debug.stats.objectCount&&this.renderStats(1,"Objects",`${this.currentScene.objects.length} objects`),this.renderGrid(),this.currentScene.flaggedForMapChange&&this.currentScene.changeMap(this.currentScene.flaggedForMapChange),this.engineTimer+=this.delta,this.engineTimer>1&&(this.engine(),this.engineTimer=0),window.requestAnimationFrame(this.frame.bind(this))}setDelta(e){this.delta=(e-this.lastRenderTimestamp)/1e3,this.lastRenderTimestamp=e}renderStats(t,i,s){this.context.fillStyle="red",this.context.font="12px serif",this.context.fillText(s,this.CANVAS_WIDTH-50,(t+1)*e.TILE_SIZE)}renderGrid(){if((this.debug.ui.grid.lines||this.debug.ui.grid.numbers)&&t.fillRectangle(this.context,0,0,this.CANVAS_WIDTH,this.CANVAS_HEIGHT,{colour:"rgba(0, 0, 0, 0.25)"}),this.debug.ui.grid.lines)for(let i=0;i<this.CANVAS_WIDTH;i+=e.TILE_SIZE)for(let s=0;s<this.CANVAS_HEIGHT;s+=e.TILE_SIZE)t.strokeRectangle(this.context,i,s,e.TILE_SIZE,e.TILE_SIZE,"black");if(this.debug.ui.grid.numbers)for(let t=0;t<e.CANVAS_TILE_WIDTH;t++)for(let i=0;i<e.CANVAS_TILE_HEIGHT;i++)this.context.fillStyle="black",this.context.font="8px helvetica",this.context.fillText(`${t}`,t*e.TILE_SIZE+1,i*e.TILE_SIZE+8),this.context.fillText(`${i}`,t*e.TILE_SIZE+6,i*e.TILE_SIZE+14)}initialiseDebuggerListeners(){void 0!==this.engineControls&&(this.engineControls.gridLines&&this.engineControls.gridLines.addEventListener("click",(()=>{this.debug.ui.grid.lines=!this.debug.ui.grid.lines})),this.engineControls.gridNumbers&&this.engineControls.gridNumbers.addEventListener("click",(()=>{this.debug.ui.grid.numbers=!this.debug.ui.grid.numbers})),this.engineControls.breakpoint&&this.engineControls.breakpoint.addEventListener("click",(()=>{this.debug.breakpoint.frame=!this.debug.breakpoint.frame})),this.engineControls.fps&&this.engineControls.fps.addEventListener("click",(()=>{this.debug.stats.fps=!this.debug.stats.fps})),this.engineControls.objectCount&&this.engineControls.objectCount.addEventListener("click",(()=>{this.debug.stats.objectCount=!this.debug.stats.objectCount})),this.engineControls.timingFrame&&this.engineControls.timingFrame.addEventListener("click",(()=>{this.debug.timing.frame=!this.debug.timing.frame})),this.engineControls.timingFrameBackground&&this.engineControls.timingFrameBackground.addEventListener("click",(()=>{this.debug.timing.frameBackground=!this.debug.timing.frameBackground})),this.engineControls.timingFrameRender&&this.engineControls.timingFrameRender.addEventListener("click",(()=>{this.debug.timing.frameRender=!this.debug.timing.frameRender})),this.engineControls.timingFrameUpdate&&this.engineControls.timingFrameUpdate.addEventListener("click",(()=>{this.debug.timing.frameUpdate=!this.debug.timing.frameUpdate})),this.engineControls.canvasLayers&&this.engineControls.canvasLayers.addEventListener("click",(()=>{this.debug.ui.canvasLayers=!this.debug.ui.canvasLayers})),this.engineControls.renderBoundary&&this.engineControls.renderBoundary.addEventListener("click",(()=>{this.debug.object.renderBoundary=!this.debug.object.renderBoundary})),this.engineControls.renderBackground&&this.engineControls.renderBackground.addEventListener("click",(()=>{this.debug.object.renderBackground=!this.debug.object.renderBackground})),this.engineControls.fullscreen&&this.engineControls.fullscreen.addEventListener("click",(()=>{this.canvas.requestFullscreen().catch((e=>{throw new Error(e)}))})))}intialiseGamepadListeners(){window.addEventListener("gamepadconnected",(e=>{console.log("Gamepad connected at index %d: %s. %d buttons, %d axes.",e.gamepad.index,e.gamepad.id,e.gamepad.buttons.length,e.gamepad.axes.length),this.gamepad=e.gamepad})),window.addEventListener("gamepaddisconnected",(e=>{this.gamepad=void 0}))}engine(){if(null===this.engineObjectList)return;let e=document.createElement("ul");this.engineObjectList.innerHTML="",this.engineObjectList.appendChild(e),this.currentScene.objects.forEach((t=>{let i=document.createElement("li");i.innerHTML=t.constructor.name,e.appendChild(i),i.addEventListener("click",(()=>{this.engineSelectedObjectId=t.id,this.updateEngineObjectDetails()}))}))}updateEngineObjectDetails(){if(void 0===this.engineSelectedObjectId)return;if(null===this.engineObjectDetails)return;let e=this.currentScene.objects.find((e=>e.id===this.engineSelectedObjectId));void 0!==e&&(this.engineObjectDetails.innerHTML="",this.engineObjectDetails.innerHTML+=`<h3>${e.constructor.name}</h3>`,Object.keys(e).forEach((t=>{let i="";i+='<div style="display:flex; padding: 0.25rem 0;">',i+=`<span style="margin-right: auto;">${t}</span>`,i+=`<input value="${e[t]}"`,i+="</div>",this.engineObjectDetails.innerHTML+=i})))}}class s{static getMousePosition(t,i){let s,n=t.getBoundingClientRect(),r={height:n.height,width:n.width},o={clientX:i.clientX,clientY:i.clientY};if(t.width>t.height){s=t.width/n.width,r.height=t.height/s;let e=n.height-r.height;o.clientY-=e/2}else{s=t.height/n.height,r.width=t.width/s;let e=n.width-r.width;o.clientX-=e/2}let a=t.width/r.width,h=t.height/r.height,d=(o.clientX-n.left)*a/e.TILE_SIZE,c=(o.clientY-n.top)*h/e.TILE_SIZE;return{x:Math.floor(d),y:Math.floor(c),exactX:d,exactY:c}}static setCursor(e,t){e.style.cursor=`url("${t}"), auto`}static get isFullscreen(){return null!==document.fullscreenElement}static isClickWithin(e,t,i,s,n){return e.exactX>=t&&e.exactX<=t+s&&e.exactY>=i&&e.exactY<=i+n}static wasClicked(e,t){return!!t.globals.mouse.click.left&&!!this.isClickWithin(t.globals.mouse.position,e.boundingBox.left,e.boundingBox.top,e.width,e.height)}}class n{constructor(e){this.client=e,this.backgroundLayersAnimationTimer={},this.objects=[],this.globals={mouse:{click:{left:!1,middle:!1,right:!1},position:{x:0,y:0,exactX:0,exactY:0}},camera:{startX:0,startY:0,endX:0,endY:0},keyboard:{},latestMouseEvent:new MouseEvent("")},this.flaggedForMapChange=void 0,this.renderingContext={background:[],objects:[]},this.eventEmitter=document.createElement("eventEmitter"),this.eventTypes={},this.backgroundLayerAnimationFrame={},this.context=this.client.context,this.assets=this.client.assets,e.canvas.addEventListener("mousemove",(t=>{this.globals.mouse.position=s.getMousePosition(e.canvas,t),this.globals.latestMouseEvent=t})),e.canvas.addEventListener("mousedown",(e=>{switch(console.log("[mousedown]",e),e.button){case 0:this.globals.mouse.click.left=!0;break;case 1:this.globals.mouse.click.middle=!0;break;case 2:this.globals.mouse.click.right=!0}})),e.canvas.addEventListener("mouseup",(e=>{switch(console.log("[mouseup]",e),e.button){case 0:this.globals.mouse.click.left=!1;break;case 1:this.globals.mouse.click.middle=!1;break;case 2:this.globals.mouse.click.right=!1}})),e.canvas.addEventListener("touchstart",(e=>{console.log("[touchstart]",e),this.globals.mouse.click.left=!0})),e.canvas.addEventListener("touchend",(e=>{console.log("[touchend]",e),this.globals.mouse.click.left=!1})),document.addEventListener("keydown",(e=>{e.repeat||(console.log("[keydown]",e),this.globals.keyboard[e.key.toLocaleLowerCase()]=!0)})),document.addEventListener("keyup",(e=>{e.repeat||(console.log("[keyup]",e),this.globals.keyboard[e.key.toLocaleLowerCase()]=!1)}))}frame(e){this.renderBackground(e),this.updateObjects(e),this.renderObjects(e),this.customRenderer?this.customRenderer(this.renderingContext):this.defaultRenderer(),this.destroyObjects(e)}renderBackground(e){this.client.debug.timing.frameBackground&&console.time("[frame] background"),this.backgroundLayers.forEach(((i,s)=>{let n=this.renderingContext.background[s];t.clearCanvas(n);for(let s=0;s<this.map.width;s++)for(let r=0;r<this.map.height;r++){let o,a=i.tiles[s]?i.tiles[s][r]:void 0;if(void 0!==a){if(1===a.animationFrames.length)o=a.animationFrames[0];else{let t;void 0===this.backgroundLayersAnimationTimer[i.index]&&(this.backgroundLayersAnimationTimer[i.index]={}),void 0===this.backgroundLayersAnimationTimer[i.index][s]&&(this.backgroundLayersAnimationTimer[i.index][s]={}),t=void 0===this.backgroundLayersAnimationTimer[i.index][s][r]?0:this.backgroundLayersAnimationTimer[i.index][s][r]+e,t>a.animationFrameDuration&&(t%=a.animationFrameDuration);for(let e=0;e<a.animationMap.length;e++)if(t<=a.animationMap[e]){o=a.animationFrames[e];break}this.backgroundLayersAnimationTimer[i.index][s][r]=t}t.renderSprite(n,this.assets.images[a.tileset],o.spriteX,o.spriteY,s,r)}}})),this.client.debug.timing.frameBackground&&console.timeEnd("[frame] background")}updateObjects(e){this.client.debug.timing.frameUpdate&&console.time("[frame] update"),this.objects.forEach((t=>{t.update&&t.update(e)})),this.client.debug.timing.frameUpdate&&console.timeEnd("[frame] update")}renderObjects(e){this.client.debug.timing.frameRender&&console.time("[frame] render"),this.renderingContext.objects.forEach((e=>{t.clearCanvas(e)})),this.objects.forEach((e=>{this.client.debug.object.renderBackground&&e.debuggerRenderBackground(this.renderingContext.objects[e.renderLayer]),e.render&&e.isRenderable&&e.render(this.renderingContext.objects[e.renderLayer]),this.client.debug.object.renderBoundary&&e.debuggerRenderBoundary(this.renderingContext.objects[e.renderLayer])})),this.client.debug.timing.frameRender&&console.timeEnd("[frame] render")}destroyObjects(e){this.client.debug.timing.frameDestroy&&console.time("[frame] destroy"),this.objects.forEach((e=>{e.flaggedForDestroy&&this.removeObjectById(e.id)})),this.client.debug.timing.frameDestroy&&console.timeEnd("[frame] destroy")}defaultRenderer(){this.globals.camera.startX=0,this.globals.camera.startY=0,this.globals.camera.endX=0,this.globals.camera.endY=0,this.renderingContext.background.forEach((e=>{this.context.drawImage(e.canvas,0,0)})),this.renderingContext.objects.forEach((e=>{this.context.drawImage(e.canvas,0,0)}))}addObject(e){this.objects.push(e)}removeObjectById(e){let t=this.objects.find((t=>t.id===e));void 0!==t&&(t.destroy&&t.destroy(),this.objects.splice(this.objects.indexOf(t),1))}getObjectsByType(e){return this.objects.filter((t=>t instanceof e))}hasCollisionAtPosition(e,t,i){let s=this.objects.find((i=>i.positionX===e&&i.positionY===t&&i.hasCollision));return void 0!==s&&i!==s}willHaveCollisionAtPosition(e,t,i){let s=this.objects.find((i=>i.targetX===e&&i.targetY===t&&i.hasCollision));return void 0!==s&&i!==s}isOutOfBounds(e,t){return e>this.map.width-1||t>this.map.height-1||e<0||t<0}hasOrWillHaveCollisionAtPosition(e,t,i){return this.hasCollisionAtPosition(e,t,i)||this.willHaveCollisionAtPosition(e,t,i)}getObjectAtPosition(t,i,s){return this.objects.find((s=>s.positionX===t&&s.positionY===i&&s.collisionLayer!==e.UI_COLLISION_LAYER))}getAllObjectsAtPosition(t,i,s){return this.objects.filter((s=>s.positionX===t&&s.positionY===i&&s.collisionLayer!==e.UI_COLLISION_LAYER))}removeAllObjects(){for(;this.objects.length>0;)this.removeObjectById(this.objects[0].id)}removeAllBackgroundLayers(){this.backgroundLayers=[]}setUpRenderingContexts(){this.renderingContext={background:[],objects:[]};for(let e=0;e<this.backgroundLayers.length;e++){let i=this.createCanvas();this.renderingContext.background[e]=t.getContext(i)}for(let i=0;i<e.OBJECT_RENDERING_LAYERS;i++){let e=this.createCanvas();this.renderingContext.objects[i]=t.getContext(e)}}createCanvas(){let e=t.createCanvas(this.map.width,this.map.height);return this.client.debug.ui.canvasLayers&&this.client.container.append(e),e}flagForMapChange(e){this.flaggedForMapChange=e}changeMap(e){void 0!==this.map&&this.map.destroy(),this.removeAllObjects(),this.removeAllBackgroundLayers(),console.log("[Scene] changing map to",e),this.map=Reflect.construct(e,[this]),this.backgroundLayers.push(...this.map.backgroundLayers),this.objects.push(...this.map.objects),this.setUpRenderingContexts(),this.flaggedForMapChange=void 0}changeScene(e){this.client.changeScene(e)}setCustomRenderer(e){this.customRenderer=e}removeCustomerRenderer(){this.customRenderer=void 0}addEventListener(e,t){this.eventEmitter.addEventListener(e,t)}removeEventListener(e,t){this.eventEmitter.removeEventListener(e,t)}dispatchEvent(e,t){let i=new CustomEvent(e,{detail:t});console.log("[dispatchEvent]",i),this.eventEmitter.dispatchEvent(i)}}class r{constructor(e){this.scene=e,this.globals={},this.context=this.scene.context,this.assets=this.scene.assets}destroy(){}}const o={tileset:"sprites",animationFrameDuration:1,animationFrames:[],animationMap:[1]},a={...o,animationFrames:[{spriteX:0,spriteY:0}]},h={...o,animationFrames:[{spriteX:0,spriteY:9}]},d={...o,animationFrames:[{spriteX:0,spriteY:10}]},c={...o,animationFrames:[{spriteX:0,spriteY:11}]},l={...o,animationFrames:[{spriteX:0,spriteY:15}]},g=[a,a,a,a,a,a,a,a,a,a,h,d,c,l,l,l],u={index:0,tiles:[g,g,g,g,g,g,g,g,g,g]};class m{get boundingBox(){let e=this.width/2,t=this.height/2;return{top:this.positionY-t,right:this.positionX+e,bottom:this.positionY+t,left:this.positionX-e}}constructor(e,t){var i,s,n,r,o,a;this.scene=e,this.id=crypto.randomUUID(),this.positionX=-1,this.positionY=-1,this.targetX=-1,this.targetY=-1,this.width=1,this.height=1,this.keyListeners={},this.eventListeners={},this.flaggedForRender=!0,this.flaggedForUpdate=!0,this.flaggedForDestroy=!1,this.mainContext=this.scene.context,this.assets=this.scene.assets,void 0!==t.positionX&&(this.positionX=t.positionX,void 0===t.targetX&&(this.targetX=this.positionX)),void 0!==t.positionY&&(this.positionY=t.positionY,void 0===t.targetY&&(this.targetY=this.positionY)),void 0!==t.targetX&&(this.targetX=t.targetX),void 0!==t.targetY&&(this.targetY=t.targetY),void 0!==t.width&&(this.width=t.width),void 0!==t.height&&(this.height=t.height),this.isRenderable=null!==(i=t.isRenderable)&&void 0!==i&&i,this.renderLayer=null!==(s=t.renderLayer)&&void 0!==s?s:0,this.renderOpacity=null!==(n=t.renderOpacity)&&void 0!==n?n:1,this.hasCollision=null!==(r=t.hasCollision)&&void 0!==r&&r,this.collisionLayer=null!==(o=t.collisionLayer)&&void 0!==o?o:0,this.renderScale=null!==(a=t.renderScale)&&void 0!==a?a:1}debuggerRenderBoundary(i){t.strokeRectangle(i,Math.floor(this.boundingBox.left*e.TILE_SIZE),Math.floor(this.boundingBox.top*e.TILE_SIZE),Math.floor(this.width*e.TILE_SIZE),Math.floor(this.height*e.TILE_SIZE),"red")}debuggerRenderBackground(i){t.fillRectangle(i,this.boundingBox.left,this.boundingBox.top,Math.floor(this.width*e.TILE_SIZE),Math.floor(this.height*e.TILE_SIZE),{colour:"red"})}get cameraRelativePositionX(){return this.positionX+this.scene.globals.camera.startX}get cameraRelativePositionY(){return this.positionY+this.scene.globals.camera.startY}get pixelWidth(){return this.width*e.TILE_SIZE}get pixelHeight(){return this.height*e.TILE_SIZE}isCollidingWith(e){return this.isWithinHorizontalBounds(e)&&this.isWithinVerticalBounds(e)}isWithinHorizontalBounds(e){return e.boundingBox.left>=this.boundingBox.left&&e.boundingBox.left<=this.boundingBox.right||e.boundingBox.right>=this.boundingBox.left&&e.boundingBox.right<=this.boundingBox.right}isWithinVerticalBounds(e){return e.boundingBox.top>=this.boundingBox.top&&e.boundingBox.top<=this.boundingBox.bottom||e.boundingBox.bottom>=this.boundingBox.top&&e.boundingBox.bottom<=this.boundingBox.bottom}}class p extends m{constructor(e,t){var i;super(e,t),this.scene=e,this.isRenderable=!0,this.hasCollision=!1,this.width=t.width,this.height=t.height,this.tileset=t.tileset,this.spriteX=t.spriteX,this.spriteY=t.spriteY,this.renderLayer=null!==(i=t.renderLayer)&&void 0!==i?i:0}render(e){t.renderSprite(e,this.assets.images.sprites,this.spriteX,this.spriteY,this.positionX,this.positionY,this.width,this.height,{centered:!0})}}class b{}var E;b.DEFAULT_PIPE_SPEED=4,b.DEFAULT_PLAYER_GRAVITY=48,b.DEFAULT_PLAYER_ACCELERATION=-12,b.DEFAULT_PIPE_GAP=3,b.DEFAULT_PIPE_REGION=8,function(e){e.GameIdle="GameIdle",e.GameStart="GameStart",e.GameEnd="GameEnd"}(E||(E={}));const I={default:new class{constructor(e,t){this.tileset=e,this.frames=t,this.duration=t.reduce(((e,t)=>e+t.duration),0)}currentFrame(e){let t=e%this.duration,i=0;for(let e=0;e<this.frames.length;e++)if(i+=this.frames[e].duration,t<i)return this.frames[e];return this.frames[0]}}("sprites",[{spriteX:.1875,spriteY:30.6875,duration:.0625},{spriteX:1.9375,spriteY:30.6875,duration:.0625},{spriteX:3.6875,spriteY:30.6875,duration:.0625},{spriteX:1.9375,spriteY:30.6875,duration:.0625}])};class L extends m{constructor(e,t){super(e,t),this.scene=e,this.isRenderable=!0,this.renderLayer=12,this.width=1.0625,this.height=.75,this.speed=0,this.animationEnabled=!0,this.animation={index:0,timer:0},this.positionX=this.startingX,this.positionY=this.startingY,this.animations=I,this.state="playing",this.scene.addEventListener(E.GameIdle,this.onGameIdle.bind(this)),this.scene.addEventListener(E.GameStart,this.onGameStart.bind(this)),this.scene.addEventListener(E.GameEnd,this.onGameOver.bind(this))}update(e){switch(this.state){case"idle":break;case"playing":this.updatePlaying(e);break;case"game-over":this.updateGameOver(e)}}updatePlaying(e){this.updateGravity(e),this.updateFlap(e),this.positionY+=this.speed*e,this.updateAnimationTimer(e)}updateGameOver(t){this.positionY>e.CANVAS_TILE_HEIGHT-3||(this.speed+=48*t,this.positionY+=this.speed*t)}render(e){this.renderPlayer(e)}updateGravity(e){this.speed+=48*e}updateFlap(e){(this.scene.globals.mouse.click.left||this.scene.globals.keyboard[" "])&&(this.scene.globals.mouse.click.left=!1,this.scene.globals.keyboard[" "]=!1,this.speed>0&&(this.speed=0),this.speed+=-12)}updateAnimationTimer(e){this.animationEnabled&&(this.animation.timer=(this.animation.timer+e)%this.animations.default.duration)}renderPlayer(e){let i=this.animations.default,s=i.currentFrame(this.animation.timer);t.renderSprite(e,this.assets.images[i.tileset],s.spriteX,s.spriteY,this.positionX,this.positionY,this.width,this.height,{centered:!0})}onGameIdle(){this.state="idle",this.positionX=this.startingX,this.positionY=this.startingY,this.speed=0}onGameStart(){this.speed=-12,this.state="playing"}onGameOver(){this.state="game-over"}get startingX(){return e.CANVAS_TILE_WIDTH/2}get startingY(){return e.CANVAS_TILE_HEIGHT/2}}const f={0:{spriteX:8.5,spriteY:19},1:{spriteX:8.5625,spriteY:29.6875},2:{spriteX:8.5,spriteY:30.4375},3:{spriteX:8.125,spriteY:31.1875},4:{spriteX:31.375,spriteY:-.125},5:{spriteX:31.375,spriteY:.625},6:{spriteX:31.5,spriteY:1.5},7:{spriteX:31.5,spriteY:2.5},8:{spriteX:18.25,spriteY:15},9:{spriteX:19.375,spriteY:12.75}},v={0:{spriteX:30.875,spriteY:3.75},1:{spriteX:8.35,spriteY:28.45},2:{spriteX:18.125,spriteY:10},3:{spriteX:19,spriteY:10},4:{spriteX:19.875,spriteY:10},5:{spriteX:20.75,spriteY:10},6:{spriteX:18.125,spriteY:11.5},7:{spriteX:19,spriteY:11.5},8:{spriteX:19.875,spriteY:11.5},9:{spriteX:20.75,spriteY:11.5}};class T extends m{constructor(t,i){super(t,i),this.scene=t,this.isRenderable=!0,this.renderLayer=e.UI_COLLISION_LAYER,this.positionX=e.CANVAS_CENTER_TILE_X,this.positionY=2,this.width=e.CANVAS_TILE_WIDTH,this.height=1.125}render(e){let i=this.scene.globals.score.toString().split("");i.forEach(((s,n)=>{let r="1"===s?.16:0;t.renderSprite(e,this.assets.images.sprites,v[s].spriteX,v[s].spriteY,this.positionX-(i.length-1)/2+n+r,this.positionY,void 0,this.height,{centered:!0})}))}}const _=2.25;class C extends m{constructor(t,i){super(t,i),this.scene=t,this.isRenderable=!0,this.renderLayer=10,this.offset=0,this.checkCollision=!0,this.movingFloor=!1,this.player=i.player,this.height=2,this.width=e.CANVAS_TILE_WIDTH,this.positionX=e.CANVAS_CENTER_TILE_X,this.positionY=e.CANVAS_TILE_HEIGHT-this.height/2,this.scene.addEventListener(E.GameStart,this.onGameStart.bind(this)),this.scene.addEventListener(E.GameEnd,this.onGameOver.bind(this))}update(e){this.checkCollision&&this.updateCheckIfPlayerAboveGround(e),this.movingFloor&&(this.offset+=4*e,this.offset%=_)}render(e){this.renderFloor(e)}updateCheckIfPlayerAboveGround(e){this.isWithinVerticalBounds(this.player)&&this.scene.dispatchEvent(E.GameEnd)}renderFloor(e){for(let i=0;i<this.width+4.5;i+=_)t.renderSprite(e,this.assets.images.sprites,19,0,this.boundingBox.left+i-this.offset,this.positionY,_,this.height,{centered:!0})}onGameStart(){this.checkCollision=!0,this.movingFloor=!0}onGameOver(){this.checkCollision=!1,this.movingFloor=!1}}const S=()=>{};class y extends m{constructor(e,t){var i,s,n;super(e,t),this.scene=e,this.timer=0,this.intervalsComplete=0,this.duration=null!==(i=t.duration)&&void 0!==i?i:1,this.onInterval=null!==(s=t.onInterval)&&void 0!==s?s:S,this.onDestroy=null!==(n=t.onDestroy)&&void 0!==n?n:void 0,this.maxIntervals=t.maxIntervals}update(e){this.timer+=e,this.timer>=this.duration&&(this.onInterval(),this.timer-=this.duration,this.intervalsComplete++,this.maxIntervals&&this.intervalsComplete>=this.maxIntervals&&this.scene.removeObjectById(this.id))}destroy(){this.onDestroy&&this.onDestroy(),console.log("[IntervalObject] destroyed")}}class A{static randomIntFromRange(e,t){return Math.floor(this.randomNumberFromRange(e,t))}static randomNumberFromRange(e,t){return Math.random()*(t-e+1)+e}static randomStartingDelta(e){return Math.random()*(null!=e?e:1)}}const k=1.625,x=.8125,Y=5.25,X=20.1875,N=1.625,w=.8125,B=5.25,j=29.375,G=1.625,R=.8125,O=3.5,H=29.375;class D extends m{constructor(t,i){super(t,i),this.scene=t,this.isRenderable=!0,this.width=1.625,this.canMove=!0,this.player=i.player,this.type=i.type,this.height=i.height,this.positionY="top"===this.type?this.height/2:e.CANVAS_TILE_HEIGHT-this.height/2,this.positionX=e.CANVAS_TILE_WIDTH+2,this.scene.addEventListener(E.GameIdle,this.onGameIdle.bind(this)),this.scene.addEventListener(E.GameEnd,this.onGameEnd.bind(this))}update(e){this.canMove&&(this.updatePosition(e),this.updateCollidingWithPlayer(e))}render(e){switch(this.type){case"top":this.renderTopPipe(e);break;case"bottom":this.renderBottomPipe(e)}}updatePosition(e){this.positionX-=4*e,this.positionX<-3&&(this.flaggedForDestroy=!0)}updateCollidingWithPlayer(e){this.isCollidingWith(this.player)&&this.scene.dispatchEvent(E.GameEnd),this.player.positionY<0&&this.isWithinHorizontalBounds(this.player)&&this.scene.dispatchEvent(E.GameEnd)}renderTopPipe(e){let i=this.boundingBox.top,s=this.boundingBox.bottom-R/2;for(let n=i;n<s;n+=w)t.renderSprite(e,this.assets.images.sprites,B,j,this.positionX,n,N,w,{centered:!0});t.renderSprite(e,this.assets.images.sprites,O,H,this.positionX,this.boundingBox.bottom-R/2,G,R,{centered:!0})}renderBottomPipe(e){let i=this.boundingBox.top+x/2,s=this.boundingBox.bottom-R/2;for(let n=i;n<s;n+=w)t.renderSprite(e,this.assets.images.sprites,B,j,this.positionX,n,N,w,{centered:!0});t.renderSprite(e,this.assets.images.sprites,Y,X,this.positionX,i,k,x,{centered:!0})}onGameIdle(){this.flaggedForDestroy=!0}onGameEnd(){this.canMove=!1}}class F extends m{constructor(t,i){super(t,i),this.scene=t,this.isRenderable=!0,this.width=1,this.height=e.CANVAS_TILE_HEIGHT,this.player=i.player,this.positionX=e.CANVAS_TILE_WIDTH+3.25,this.positionY=e.CANVAS_CENTER_TILE_Y,this.scene.addEventListener(E.GameEnd,this.onGameOver.bind(this))}update(e){this.updatePosition(e),this.updatePoints(e)}render(e){}updatePosition(e){this.positionX-=4*e,this.positionX<-3&&(this.flaggedForDestroy=!0)}updatePoints(e){this.isWithinHorizontalBounds(this.player)&&(this.scene.globals.score++,this.flaggedForDestroy=!0)}onGameOver(){this.flaggedForDestroy=!0}}class V extends m{constructor(t,i){super(t,i),this.scene=t,this.isRenderable=!0,this.renderLayer=e.UI_COLLISION_LAYER,this.positionX=e.CANVAS_CENTER_TILE_X,this.positionY=e.CANVAS_CENTER_TILE_Y,this.width=7.5,this.height=4}render(e){this.renderBackground(e)}renderBackground(e){t.renderSprite(e,this.assets.images.sprites,0,16,this.positionX,this.positionY,7.5,4,{centered:!0})}destroy(){}}const P={bronze:{spriteX:7,spriteY:29.75},silver:{spriteX:7,spriteY:28.25},gold:{spriteX:7.5,spriteY:17.5},platinum:{spriteX:7.5,spriteY:16}};class M extends m{constructor(t,i){super(t,i),this.scene=t,this.isRenderable=!0,this.renderLayer=e.UI_COLLISION_LAYER,this.score=i.score}render(e){this.renderScore(e)}renderScore(e){let i=this.score.toString().split(""),s=this.positionX,n=.5625*(i.length-1);i.forEach(((i,r)=>{t.renderSprite(e,this.assets.images.sprites,f[i].spriteX,f[i].spriteY,s-n+.5625*r,this.positionY,.5,.75,{centered:!0})}))}}class Z extends m{constructor(e,t){super(e,t),this.scene=e,this.continueTimer=0,this.continueDuration=.5,this.player=t.player,this.scene.addEventListener(E.GameIdle,this.onGameIdle.bind(this)),this.scene.addEventListener(E.GameStart,this.onGameStart.bind(this)),this.scene.addEventListener(E.GameEnd,this.onGameEnd.bind(this)),this.scene.dispatchEvent(E.GameIdle)}update(e){switch(this.state){case"idle":this.updateGameIdle();break;case"game-over":this.updateGameEnd(e)}}onGameIdle(){"idle"!==this.state&&(this.cleanupGameEnd(),this.state="idle",this.scene.globals.score=0,this.idleSprite=new p(this.scene,{positionX:4.5625,positionY:8.9375,width:3.675,height:3.5,tileset:"sprites",spriteX:18.25,spriteY:5.25,renderLayer:e.UI_COLLISION_LAYER}),this.scene.addObject(this.idleSprite))}onGameStart(){"playing"!==this.state&&(this.state="playing",this.idleSprite&&(this.idleSprite.flaggedForDestroy=!0),this.interval=new y(this.scene,{duration:2,onInterval:()=>{let t=b.DEFAULT_PIPE_GAP,i=e.CANVAS_TILE_HEIGHT/2-4,s=A.randomNumberFromRange(i,i+4);this.scene.addObject(new D(this.scene,{player:this.player,type:"top",height:s})),this.scene.addObject(new D(this.scene,{player:this.player,type:"bottom",height:e.CANVAS_TILE_HEIGHT-s-t})),this.scene.addObject(new F(this.scene,{player:this.player}))}}),this.scene.addObject(this.interval))}onGameEnd(){"game-over"!==this.state&&(this.state="game-over",this.interval&&(this.interval.flaggedForDestroy=!0),this.scorecard=new V(this.scene,{}),this.scene.addObject(this.scorecard),"none"!==this.medalType&&(this.medal=new p(this.scene,{positionX:2.45,positionY:8.125,width:1.5,height:1.5,tileset:"sprites",spriteX:P[this.medalType].spriteX,spriteY:P[this.medalType].spriteY,renderLayer:e.UI_COLLISION_LAYER}),this.scene.addObject(this.medal)),this.score=new M(this.scene,{positionX:7.125,positionY:7.5,score:this.scene.globals.score}),this.scene.addObject(this.score),this.scene.globals.score>this.scene.globals.highscore&&(this.scene.globals.highscore=this.scene.globals.score,localStorage.setItem("highscore",this.scene.globals.score.toString())),this.highscore=new M(this.scene,{positionX:7.125,positionY:9,score:this.scene.globals.highscore}),this.scene.addObject(this.highscore),this.continueTimer=0)}cleanupGameEnd(){this.scorecard&&(this.scorecard.flaggedForDestroy=!0),this.medal&&(this.medal.flaggedForDestroy=!0),this.score&&(this.score.flaggedForDestroy=!0),this.highscore&&(this.highscore.flaggedForDestroy=!0)}updateGameEnd(e){this.continueTimer+=e,this.continueTimer<this.continueDuration||(this.scene.globals.keyboard[" "]||this.scene.globals.mouse.click.left)&&(this.scene.globals.keyboard[" "]=!1,this.scene.globals.mouse.click.left=!1,this.scene.dispatchEvent(E.GameIdle))}updateGameIdle(){(this.scene.globals.keyboard[" "]||this.scene.globals.mouse.click.left)&&(this.scene.globals.keyboard[" "]=!1,this.scene.globals.mouse.click.left=!1,this.scene.dispatchEvent(E.GameStart))}get medalType(){return this.scene.globals.score>=40?"platinum":this.scene.globals.score>=30?"gold":this.scene.globals.score>=20?"silver":this.scene.globals.score>=10?"bronze":"none"}}const W=e.CANVAS_TILE_HEIGHT,U=e.CANVAS_TILE_WIDTH;class $ extends r{constructor(t){super(t),this.scene=t,this.height=W,this.width=U,this.backgroundLayers=[],this.objects=[],this.objects.push(new p(this.scene,{positionX:e.CANVAS_CENTER_TILE_X,positionY:e.CANVAS_CENTER_TILE_Y,width:e.CANVAS_TILE_WIDTH,height:e.CANVAS_TILE_HEIGHT,tileset:"sprites",spriteY:0,spriteX:0}));let i=new L(this.scene,{});this.objects.push(i),this.objects.push(new Z(this.scene,{player:i})),this.objects.push(new T(this.scene,{})),this.objects.push(new C(this.scene,{player:i}))}}class z extends n{constructor(e){super(e),this.client=e,this.globals.score=0,this.globals.highscore=null===localStorage.getItem("highscore")?0:Number(localStorage.getItem("highscore")),this.changeMap($)}}class J extends m{constructor(t,i){super(t,i),this.scene=t,this.isRenderable=!0,this.width=3.5,this.height=2,this.positionX=e.CANVAS_TILE_WIDTH/2,this.positionY=e.CANVAS_TILE_HEIGHT/2}update(e){this.scene.globals.mouse.click.left&&(this.scene.globals.mouse.click.left=!1,s.isClickWithin(this.scene.globals.mouse.position,this.boundingBox.left,this.boundingBox.top,this.width,this.height)&&this.scene.changeScene(z))}render(e){t.renderSprite(e,this.assets.images.sprites,22,7.25,this.positionX,this.positionY,this.width,this.height,{centered:!0})}}const q=e.CANVAS_TILE_HEIGHT,K=e.CANVAS_TILE_WIDTH;class Q extends r{constructor(t){super(t),this.scene=t,this.height=q,this.width=K,this.backgroundLayers=[u],this.objects=[],this.objects.push(new J(this.scene,{})),this.objects.push(new p(this.scene,{positionX:e.CANVAS_TILE_WIDTH/2,positionY:3,width:6,height:1.8,tileset:"sprites",spriteX:21.75,spriteY:5.5}))}}class ee extends n{constructor(e){super(e),this.client=e,this.changeMap(Q)}}class te{static get engineObjectList(){return document.getElementById("object-list")||null}static get engineObjectDetails(){return document.getElementById("object-details")||null}static get engineControls(){return{gridLines:document.getElementById("btnGridLines"),gridNumbers:document.getElementById("btnGridNumbers"),breakpoint:document.getElementById("btnBreakpoint"),fps:document.getElementById("btnFps"),objectCount:document.getElementById("btnObjectCount"),timingFrame:document.getElementById("btnTimingFrame"),timingFrameBackground:document.getElementById("btnTimingFrameBackground"),timingFrameRender:document.getElementById("btnTimingFrameRender"),timingFrameUpdate:document.getElementById("btnTimingFrameUpdate"),canvasLayers:document.getElementById("btnCanvasLayers"),fullscreen:document.getElementById("btnFullscreen"),renderBoundary:document.getElementById("btnRenderBoundary"),renderBackground:document.getElementById("btnRenderBackground")}}static initHelpers(){window.o=e=>window.engine.currentScene.objects.find((t=>t.id===e))}}!function(){e.CANVAS_TILE_HEIGHT=16,e.CANVAS_TILE_WIDTH=9,e.TILE_SIZE=16;let t=new URLSearchParams(window.location.search),s=t.get("cheatcode"),n=t.get("cheatcodevalue");"joanne"!==s||null===n||isNaN(Number(n))||(b.DEFAULT_PIPE_GAP=Number(n),console.log("cheat code activated for pipe gap: "+b.DEFAULT_PIPE_GAP));const r=[ee,z];window.engine=new i(document.getElementById("render-area"),r,{images:{sprites:"assets/sprites.png"},audio:{}},te.engineObjectList,te.engineObjectDetails,te.engineControls),te.initHelpers()}()})();